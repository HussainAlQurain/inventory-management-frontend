<div class="sub-recipe-container">
  <div class="page-header">
    <h1 class="page-title">Sub-Recipes / Preparations</h1>
    <div class="header-actions">
      <button mat-raised-button [matMenuTriggerFor]="addMenu" color="primary">
        <mat-icon>add</mat-icon> Add Sub-Recipe
      </button>
      <mat-menu #addMenu="matMenu">
        <button mat-menu-item (click)="addManually()">
          <mat-icon>add_circle</mat-icon> Add Manually
        </button>
        <button mat-menu-item (click)="importFromExcel()">
          <mat-icon>upload_file</mat-icon> Import from Excel
        </button>
      </mat-menu>
      
      <button mat-raised-button color="accent" (click)="downloadSubRecipes()">
        <mat-icon>download</mat-icon> Download
      </button>
    </div>
  </div>

  <div class="filters-panel mat-elevation-z1">
    <div class="filter-row">
      <mat-form-field appearance="outline">
        <mat-label>Search by name</mat-label>
        <input matInput [(ngModel)]="nameFilter" (keyup)="applyFilters()" placeholder="Search sub-recipes...">
        <button *ngIf="nameFilter" matSuffix mat-icon-button aria-label="Clear" (click)="nameFilter=''; applyFilters()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Category</mat-label>
        <mat-select [(ngModel)]="categoryFilter" (selectionChange)="applyFilters()">
          <mat-option>All Categories</mat-option>
          <mat-option *ngFor="let category of categories" [value]="category.id">
            {{category.name}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Type</mat-label>
        <mat-select [(ngModel)]="typeFilter" (selectionChange)="applyFilters()">
          <mat-option>All Types</mat-option>
          <mat-option *ngFor="let type of recipeTypes" [value]="type.value">
            {{type.label}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    
    <div class="active-filters" *ngIf="hasActiveFilters()">
      <span class="filter-chip" *ngIf="nameFilter">
        Name: {{nameFilter}}
        <button mat-icon-button (click)="nameFilter=''; applyFilters()">
          <mat-icon>close</mat-icon>
        </button>
      </span>
      <span class="filter-chip" *ngIf="categoryFilter">
        Category: {{getCategoryName(categoryFilter)}}
        <button mat-icon-button (click)="categoryFilter=null; applyFilters()">
          <mat-icon>close</mat-icon>
        </button>
      </span>
      <span class="filter-chip" *ngIf="typeFilter">
        Type: {{getTypeName(typeFilter)}}
        <button mat-icon-button (click)="typeFilter=null; applyFilters()">
          <mat-icon>close</mat-icon>
        </button>
      </span>
      <button mat-button color="warn" (click)="clearAllFilters()">Clear All</button>
    </div>
  </div>

  <div class="table-container">
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
    
    <div *ngIf="error" class="error-container">
      <p class="error-message">{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadSubRecipes()">Retry</button>
    </div>
    
    <div *ngIf="!isLoading && !error && filteredSubRecipes.length === 0" class="no-data-container">
      <p>No sub-recipes match your filters</p>
      <button mat-raised-button color="primary" (click)="clearAllFilters()">Clear Filters</button>
    </div>
    
    <table *ngIf="!isLoading && !error && filteredSubRecipes.length > 0" 
           mat-table [dataSource]="filteredSubRecipes" matSort class="sub-recipe-table">
      
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
        <td mat-cell *matCellDef="let recipe"> {{ recipe.name }} </td>
      </ng-container>

      <!-- Type Column -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Type </th>
        <td mat-cell *matCellDef="let recipe"> {{ getTypeName(recipe.type) }} </td>
      </ng-container>

      <!-- Category Column -->
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Category </th>
        <td mat-cell *matCellDef="let recipe"> {{ getCategoryName(recipe.categoryId) }} </td>
      </ng-container>

      <!-- Cost Column -->
      <ng-container matColumnDef="cost">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Cost </th>
        <td mat-cell *matCellDef="let recipe"> {{ recipe.cost | currency }} </td>
      </ng-container>

      <!-- UOM Column -->
      <ng-container matColumnDef="uom">
        <th mat-header-cell *matHeaderCellDef> UOM </th>
        <td mat-cell *matCellDef="let recipe"> 
          {{ getUomInfo(recipe.uomId) }}
        </td>
      </ng-container>

      <!-- Min On Hand Column -->
      <ng-container matColumnDef="minOnHand">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Min On Hand </th>
        <td mat-cell *matCellDef="let recipe"> N/A </td>
      </ng-container>

      <!-- PAR Column -->
      <ng-container matColumnDef="par">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> PAR </th>
        <td mat-cell *matCellDef="let recipe"> N/A </td>
      </ng-container>

      <!-- Last Count Column -->
      <ng-container matColumnDef="lastCount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Last Count </th>
        <td mat-cell *matCellDef="let recipe"> N/A </td>
      </ng-container>

      <!-- On Hand Column -->
      <ng-container matColumnDef="onHand">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> On Hand </th>
        <td mat-cell *matCellDef="let recipe"> N/A </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let recipe; columns: displayedColumns" 
          (click)="selectSubRecipe(recipe)"
          class="recipe-row"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
  </div>

  <!-- Detail Panel that slides from right -->
  <div class="detail-panel" [class.open]="showDetailPanel" *ngIf="selectedSubRecipe">
    <div class="panel-header">
      <h2>{{ selectedSubRecipe.name }}</h2>
      <button mat-icon-button (click)="closeDetailPanel()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <mat-divider></mat-divider>

    <div class="panel-content">
      <mat-tab-group>
        <!-- Details Tab -->
        <mat-tab label="Details">
          <div class="details-section">
            <div class="detail-row">
              <div class="field-label">Name:</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <input matInput [(ngModel)]="selectedSubRecipe.name">
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Type:</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <mat-select [(ngModel)]="selectedSubRecipe.type">
                    <mat-option *ngFor="let type of recipeTypes" [value]="type.value">
                      {{ type.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Category:</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <mat-select [(ngModel)]="selectedSubRecipe.categoryId">
                    <mat-option *ngFor="let category of categories" [value]="category.id">
                      {{ category.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Yield Quantity:</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <input matInput type="number" [(ngModel)]="selectedSubRecipe.yieldQty" min="0.001" step="0.001">
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Unit of Measure:</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <mat-select [(ngModel)]="selectedSubRecipe.uomId">
                    <!-- We'd need to load UOMs from the service -->
                    <mat-option *ngFor="let uom of allUoms" [value]="uom.id">
                      {{ uom.name }} ({{ uom.abbreviation }})
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Cost:</div>
              <div class="field-value">{{ selectedSubRecipe.cost | currency }}</div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Prep Time (min):</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <input matInput type="number" [(ngModel)]="selectedSubRecipe.prepTimeMinutes" min="0">
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row">
              <div class="field-label">Cook Time (min):</div>
              <div class="field-value">
                <mat-form-field appearance="outline">
                  <input matInput type="number" [(ngModel)]="selectedSubRecipe.cookTimeMinutes" min="0">
                </mat-form-field>
              </div>
            </div>
            
            <div class="detail-row full-width">
              <div class="field-label">Instructions:</div>
              <div class="field-value">
                <mat-form-field appearance="outline" class="full-width">
                  <textarea matInput [(ngModel)]="selectedSubRecipe.instructions" rows="4"></textarea>
                </mat-form-field>
              </div>
            </div>
            
            <div class="actions">
              <button mat-raised-button color="primary" (click)="saveSubRecipe(selectedSubRecipe)">
                Save Changes
              </button>
            </div>
          </div>
        </mat-tab>
        
        <!-- Lines Tab -->
        <mat-tab label="Ingredients">
          <div class="lines-section">
            <div *ngIf="isLoading" class="loading-spinner">
              <mat-spinner diameter="40"></mat-spinner>
            </div>
            
            <div *ngIf="!isLoading">
              <div class="section-header">
                <h3>Ingredients & Components</h3>
                <button mat-raised-button color="primary" (click)="addNewLine()" *ngIf="!isEditingLine">
                  <mat-icon>add</mat-icon> Add Line
                </button>
              </div>
              
              <app-sub-recipe-line-item 
                *ngIf="isEditingLine"
                [line]="currentLine"
                [isEditMode]="true"
                (save)="saveLine($event)"
                (cancel)="cancelLineEdit()"
                (delete)="deleteLine($event)">
              </app-sub-recipe-line-item>
              
              <table *ngIf="!isEditingLine && selectedSubRecipe.lines?.length" 
                     mat-table [dataSource]="selectedSubRecipe.lines || []" class="lines-table">
                <ng-container matColumnDef="item">
                  <th mat-header-cell *matHeaderCellDef>Item</th>
                  <td mat-cell *matCellDef="let line">
                    {{ line.inventoryItemName || line.childSubRecipeName || 'Unknown' }}
                  </td>
                </ng-container>
                
                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef>Type</th>
                  <td mat-cell *matCellDef="let line">
                    {{ line.inventoryItemId ? 'Inventory Item' : (line.childSubRecipeId ? 'Sub-Recipe' : 'Unknown') }}
                  </td>
                </ng-container>
                
                <ng-container matColumnDef="netQuantity">
                  <th mat-header-cell *matHeaderCellDef>Net Quantity</th>
                  <td mat-cell *matCellDef="let line">{{ line.quantity }}</td>
                </ng-container>
                
                <ng-container matColumnDef="grossQuantity">
                  <th mat-header-cell *matHeaderCellDef>Gross Quantity</th>
                  <td mat-cell *matCellDef="let line">
                    {{ line.quantity * (1 + line.wastagePercent / 100) | number:'1.2-2' }}
                  </td>
                </ng-container>
                
                <ng-container matColumnDef="wastage">
                  <th mat-header-cell *matHeaderCellDef>Wastage %</th>
                  <td mat-cell *matCellDef="let line">{{ line.wastagePercent }}%</td>
                </ng-container>
                
                <ng-container matColumnDef="uom">
                  <th mat-header-cell *matHeaderCellDef>UOM</th>
                  <td mat-cell *matCellDef="let line">
                    {{ line.uomAbbreviation || 'UOM-' + line.unitOfMeasureId }}
                  </td>
                </ng-container>
                
                <ng-container matColumnDef="cost">
                  <th mat-header-cell *matHeaderCellDef>Cost</th>
                  <td mat-cell *matCellDef="let line">{{ line.lineCost | currency }}</td>
                </ng-container>
                
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>Actions</th>
                  <td mat-cell *matCellDef="let line">
                    <button mat-icon-button color="primary" (click)="editLine(line); $event.stopPropagation()">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="deleteLine(line.id!); $event.stopPropagation()">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>
                
                <tr mat-header-row *matHeaderRowDef="['item', 'type', 'netQuantity', 'grossQuantity', 'wastage', 'uom', 'cost', 'actions']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['item', 'type', 'netQuantity', 'grossQuantity', 'wastage', 'uom', 'cost', 'actions']"></tr>
              </table>
              
              <div *ngIf="!isEditingLine && (!selectedSubRecipe.lines || selectedSubRecipe.lines.length === 0)" class="no-lines">
                <p>No ingredients or components added to this sub-recipe.</p>
                <button mat-raised-button color="primary" (click)="addNewLine()">
                  <mat-icon>add</mat-icon> Add First Line
                </button>
              </div>
              
              <div class="total-cost" *ngIf="selectedSubRecipe.lines?.length">
                <div>Total Cost: {{ selectedSubRecipe.cost | currency }}</div>
                <div>Cost Per {{ selectedSubRecipe.yieldQty }} {{ selectedSubRecipe.uomId ? 'UOM-' + selectedSubRecipe.uomId : 'units' }}</div>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>
