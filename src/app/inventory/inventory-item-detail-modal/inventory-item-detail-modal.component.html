<div class="modal-container">
  <div class="modal-header">
    <h2 mat-dialog-title>{{ item.name }}</h2>
    <button mat-icon-button (click)="close()" aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <mat-dialog-content class="mat-typography">
    <mat-tab-group>

      <!-- 1) Item Details Tab -->
      <mat-tab label="Item Details">
        <div class="details-container">
          <!-- CATEGORY (dropdown + search) -->
          <div class="detail-row">
            <span class="detail-label">Category:</span>
            <mat-form-field appearance="outline" style="width:300px;">
              <mat-label>Search / Create Category</mat-label>
              <input
                type="text"
                matInput
                [formControl]="categoryCtrl"
                [matAutocomplete]="autoCat"
                placeholder="Type to search categories"
              >
              <mat-autocomplete #autoCat="matAutocomplete" (optionSelected)="onCategorySelected($event.option.value)">
                <mat-option *ngFor="let cat of filteredCategories" [value]="cat.name">
                  {{ cat.name }}
                </mat-option>
                <!-- Option to create new if none found -->
                <mat-option *ngIf="canCreateNewCategory" (click)="createNewCategory(categoryCtrl.value)">
                  Create "<b>{{ categoryCtrl.value }}</b>" as new category
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <div class="detail-row">
            <span class="detail-label">SKU:</span>
            <mat-form-field appearance="outline" style="width:200px;">
              <input matInput [(ngModel)]="item.sku" placeholder="SKU">
            </mat-form-field>
          </div>
          <div class="detail-row">
            <span class="detail-label">Product Code:</span>
            <mat-form-field appearance="outline" style="width:200px;">
              <input matInput [(ngModel)]="item.productCode" placeholder="Product Code">
            </mat-form-field>
          </div>
          <div class="detail-row">
            <span class="detail-label">Description:</span>
            <mat-form-field appearance="outline" style="width:400px;">
              <textarea matInput rows="2" [(ngModel)]="item.description" placeholder="Description"></textarea>
            </mat-form-field>
          </div>

          <!-- Min / Par + OnHand snapshot -->
          <div class="detail-row">
            <span class="detail-label">Min On Hand:</span>
            <mat-form-field appearance="outline" style="width:150px;">
              <input matInput type="number" [(ngModel)]="item.minOnHand" placeholder="Min On Hand">
            </mat-form-field>
          </div>
          <div class="detail-row">
            <span class="detail-label">Par Level:</span>
            <mat-form-field appearance="outline" style="width:150px;">
              <input matInput type="number" [(ngModel)]="item.par" placeholder="Par Level">
            </mat-form-field>
          </div>
          <button mat-raised-button color="accent" (click)="updateAllStores()">
            Update All Stores
          </button>

          <div class="detail-row">
            <span class="detail-label">On Hand (total):</span>
            <span class="detail-value">{{ item.onHand || 0 }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">On Hand Value:</span>
            <span class="detail-value">{{ (item.onHandValue || 0) | currency }}</span>
          </div>
        </div>
      </mat-tab>

      <!-- 2) Purchase Options Tab -->
      <mat-tab label="Purchase Options">
        <div class="purchase-options-container" style="margin-top:10px;">
          <ng-container *ngIf="item.purchaseOptions?.length; else noPO">
            <table mat-table [dataSource]="item.purchaseOptions || []" class="purchase-options-table">

              <!-- Supplier, Price, etc. columns... -->
              <ng-container matColumnDef="supplier">
                <th mat-header-cell *matHeaderCellDef>Supplier</th>
                <td mat-cell *matCellDef="let option">
                  {{ option.supplier?.name || 'N/A' }}
                </td>
              </ng-container>
              <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef>Price</th>
                <td mat-cell *matCellDef="let option">
                  {{ option.price | currency }}
                  <button mat-icon-button color="primary" (click)="editPrice(option)">
                    <mat-icon>edit</mat-icon>
                  </button>
                </td>
              </ng-container>

              <!-- orderingEnabled -->
              <ng-container matColumnDef="orderingEnabled">
                <th mat-header-cell *matHeaderCellDef>Ordering</th>
                <td mat-cell *matCellDef="let option">
                  <mat-checkbox [(ngModel)]="option.orderingEnabled" (change)="onOrderingToggled(option)">
                  </mat-checkbox>
                </td>
              </ng-container>

              <!-- mainPurchaseOption -->
              <ng-container matColumnDef="mainPurchaseOption">
                <th mat-header-cell *matHeaderCellDef>Main</th>
                <td mat-cell *matCellDef="let option">
                  <mat-radio-button 
                    [checked]="option.mainPurchaseOption"
                    (change)="onSetAsMain(option)">
                  </mat-radio-button>
                </td>
              </ng-container>

              <!-- actions -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let option">
                  <button mat-icon-button color="warn" (click)="deletePurchaseOption(option)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['supplier','price','orderingEnabled','mainPurchaseOption','actions']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['supplier','price','orderingEnabled','mainPurchaseOption','actions']"></tr>
            </table>

            <button mat-raised-button color="primary" (click)="addNewPurchaseOption()">
              <mat-icon>add</mat-icon> Add Purchase Option
            </button>
          </ng-container>
          <ng-template #noPO>
            <p>No purchase options found</p>
            <button mat-raised-button color="primary" (click)="addNewPurchaseOption()">
              <mat-icon>add</mat-icon> Add Purchase Option
            </button>
          </ng-template>
        </div>
      </mat-tab>

      <!-- 3) On-Hand Tab -->
      <mat-tab label="On Hand">
        <table mat-table [dataSource]="locationInventory" class="location-inventory-table">
          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef>Location</th>
            <td mat-cell *matCellDef="let row">{{ row.location?.name }}</td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>On Hand</th>
            <td mat-cell *matCellDef="let row">{{ row.quantity }}</td>
          </ng-container>

          <ng-container matColumnDef="value">
            <th mat-header-cell *matHeaderCellDef>Value</th>
            <td mat-cell *matCellDef="let row">{{ row.value | currency }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['location','quantity','value']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['location','quantity','value']"></tr>
        </table>
      </mat-tab>
    </mat-tab-group>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="close()">Cancel</button>
    <button mat-raised-button color="primary" (click)="saveChanges()">Save</button>
  </mat-dialog-actions>
</div>
